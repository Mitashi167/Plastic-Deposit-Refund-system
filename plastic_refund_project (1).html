<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plastic Refund System | Eco-Earn</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Styles -->
    <style>
        :root {
            --primary: #10B981;
            --primary-dark: #059669;
            --secondary: #0EA5E9;
            --accent: #8B5CF6;
            --background: #F0F9FF;
            --surface: rgba(255, 255, 255, 0.7);
            --surface-border: rgba(255, 255, 255, 0.8);
            --text-main: #1E293B;
            --text-muted: #64748B;
            --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            --gradient-1: linear-gradient(135deg, #34D399, #10B981);
            --gradient-2: linear-gradient(135deg, #38BDF8, #0284C7);
            --gradient-3: linear-gradient(135deg, #A78BFA, #7C3AED);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--background);
            color: var(--text-main);
            min-height: 100vh;
            padding-bottom: 100px;
            overflow-x: hidden;
            position: relative;
            /* Desktop Centering */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Background Mesh - Fixed for Desktop */
        .background-mesh {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: #f0fdf4;
            /* Light green tint */
        }

        /* Utilities */
        .container {
            padding: 0 20px;
            width: 100%;
            max-width: 480px;
            /* Mobile width on desktop */
            margin: 0 auto;
            position: relative;
        }

        /* Desktop Only Enhancements */
        @media (min-width: 768px) {
            body {
                padding-top: 40px;
            }

            .container,
            header .container {
                max-width: 480px;
            }

            /* Make the app look like a phone on desktop */
            main.container {
                background: rgba(255, 255, 255, 0.5);
                border-radius: 32px;
                padding: 30px;
                min-height: 80vh;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.8);
            }

            .glass-header {
                background: transparent;
                backdrop-filter: none;
                border: none;
                position: absolute;
                width: 100%;
                max-width: 480px;
                top: 40px;
                z-index: 101;
            }

            .bottom-nav {
                position: absolute;
                /* Relative to body/screen on mobile, but let's fix it for desktop "phone view" */
                bottom: 40px;
                width: 400px;
            }
        }


        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: float 20s infinite ease-in-out;
        }

        .blob-1 {
            top: -10%;
            left: -10%;
            width: 500px;
            height: 500px;
            background: #a7f3d0;
            animation-delay: 0s;
        }

        .blob-2 {
            bottom: 20%;
            right: -10%;
            width: 400px;
            height: 400px;
            background: #bae6fd;
            animation-delay: -5s;
        }

        .blob-3 {
            top: 40%;
            left: 40%;
            width: 300px;
            height: 300px;
            background: #ddd6fe;
            animation-delay: -10s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0);
            }

            50% {
                transform: translate(30px, 50px);
            }
        }

        /* Utilities */
        .container {
            padding: 0 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .glass-panel {
            background: var(--surface);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--surface-border);
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            padding: 15px 0;
        }

        /* Header */
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 28px;
            color: var(--primary);
        }

        .logo h1 {
            font-size: 20px;
            font-weight: 700;
            line-height: 1.2;
        }

        .logo p {
            font-size: 11px;
            color: var(--text-muted);
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: #e2e8f0;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #64748b;
            border: 2px solid white;
            box-shadow: var(--shadow-sm);
        }

        /* Wallet Card */
        .wallet-card {
            margin-top: 24px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(255, 255, 255, 0.4));
            position: relative;
            overflow: hidden;
        }

        .wallet-card::before {
            content: '';
            position: absolute;
            top: -50px;
            right: -50px;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, rgba(16, 185, 129, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
        }

        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .wallet-header h3 {
            font-size: 14px;
            color: var(--text-muted);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .currency {
            font-size: 12px;
            font-weight: 700;
            background: #dbeafe;
            color: #2563eb;
            padding: 4px 8px;
            border-radius: 99px;
        }

        .wallet-balance {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-main);
            letter-spacing: -1px;
            margin-bottom: 24px;
        }

        .wallet-balance .symbol {
            font-size: 24px;
            color: var(--text-muted);
            margin-right: 4px;
            vertical-align: super;
        }

        .wallet-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 20px;
        }

        .eco-points {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .icon-circle {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: #ecfccb;
            color: #65a30d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .eco-points .label {
            font-size: 12px;
            color: var(--text-muted);
            display: block;
        }

        .eco-points .value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-main);
        }

        .progress-container {
            flex: 1;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-muted);
            margin-bottom: 6px;
        }

        .progress-track {
            height: 8px;
            background: #f1f5f9;
            border-radius: 99px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            width: 0%;
            background: var(--gradient-1);
            border-radius: 99px;
            transition: width 1s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Action Grid */
        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .card {
            padding: 24px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:active {
            transform: scale(0.98);
        }

        .card-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 10px;
            font-weight: 700;
            background: rgba(0, 0, 0, 0.05);
            padding: 4px 8px;
            border-radius: 6px;
            color: var(--text-muted);
        }

        .badge-new {
            position: absolute;
            top: 16px;
            right: 16px;
            font-size: 10px;
            font-weight: 700;
            background: #ffedd5;
            color: #ea580c;
            padding: 4px 8px;
            border-radius: 6px;
        }

        .card-icon {
            width: 60px;
            height: 60px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
            margin-bottom: 16px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .gradient-1 {
            background: var(--gradient-1);
        }

        .gradient-2 {
            background: var(--gradient-2);
        }

        .gradient-3 {
            background: var(--gradient-3);
        }

        .card h2 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .card p {
            font-size: 13px;
            color: var(--text-muted);
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .btn-primary {
            width: 100%;
            padding: 12px;
            border: none;
            background: var(--text-main);
            color: white;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
            transition: opacity 0.2s;
        }

        .btn-outline {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            background: transparent;
            color: var(--text-main);
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        /* Simulation Section */
        .simulation-area {
            margin-top: 30px;
            padding: 24px;
        }

        .section-header h3 {
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sim-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .sim-item h4 {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 10px;
            text-align: center;
        }

        /* QR Mock */
        .qr-scanner-mock {
            width: 100%;
            aspect-ratio: 1;
            background: #000;
            border-radius: 16px;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: rgba(255, 255, 255, 0.5);
            overflow: hidden;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: #10B981;
            box-shadow: 0 0 10px #10B981;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% {
                top: 10%;
                opacity: 0;
            }

            10% {
                opacity: 1;
            }

            90% {
                opacity: 1;
            }

            100% {
                top: 90%;
                opacity: 0;
            }
        }

        .scan-text {
            font-size: 10px;
            margin-top: 8px;
            letter-spacing: 1px;
            text-transform: uppercase;
        }

        /* Smart Bin Mock */
        .smart-bin-mock {
            width: 100%;
            aspect-ratio: 1;
            background: #f1f5f9;
            border-radius: 16px;
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 20px;
        }

        .bin-body {
            width: 60px;
            height: 80px;
            background: #cbd5e1;
            border-radius: 0 0 8px 8px;
            position: relative;
            z-index: 10;
        }

        .lid {
            position: absolute;
            bottom: 100px;
            width: 70px;
            height: 10px;
            background: #94a3b8;
            border-radius: 4px;
            z-index: 11;
        }

        .bottle-3d {
            width: 20px;
            height: 40px;
            background: rgba(56, 189, 248, 0.6);
            border-radius: 4px;
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            animation: bottleDrop 3s infinite ease-in-out;
        }

        .bottle-cap {
            width: 12px;
            height: 6px;
            background: #0284c7;
            margin: -6px auto 0;
        }

        @keyframes bottleDrop {
            0% {
                transform: translateX(-50%) translateY(-60px) rotate(10deg);
                opacity: 0;
            }

            30% {
                opacity: 1;
            }

            60% {
                transform: translateX(-50%) translateY(0) rotate(0deg);
                opacity: 1;
            }

            80% {
                opacity: 0;
            }

            100% {
                opacity: 0;
            }
        }

        .status-light {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 8px;
            height: 8px;
            background: #22c55e;
            border-radius: 50%;
            box-shadow: 0 0 5px #22c55e;
            animation: blink 2s infinite;
        }

        @keyframes blink {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.3;
            }
        }

        /* User Details */
        .user-details {
            margin-top: 30px;
            padding: 24px;
        }

        .user-details h3 {
            font-size: 18px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .input-wrapper {
            position: relative;
        }

        .input-wrapper i {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 14px 14px 44px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            font-size: 14px;
            outline: none;
            transition: all 0.2s;
        }

        .input-wrapper input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .btn-block {
            width: 100%;
            padding: 14px;
            background: var(--gradient-2);
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 700;
            font-size: 15px;
            cursor: pointer;
            box-shadow: 0 10px 20px -5px rgba(56, 189, 248, 0.4);
        }

        /* Nav */
        .bottom-nav {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 10px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.1);
            z-index: 999;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-muted);
            font-size: 10px;
            text-decoration: none;
            gap: 4px;
        }

        .nav-item i {
            font-size: 20px;
        }

        .nav-item.active {
            color: var(--primary);
        }

        .scan-fab {
            width: 50px;
            height: 50px;
            background: var(--text-main);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-top: -30px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            border: 4px solid var(--background);
        }

        /* Animations */
        .fade-up {
            animation: fadeUp 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
            opacity: 0;
            transform: translateY(20px);
        }

        .swing-in {
            animation: swingIn 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            opacity: 0;
            transform: rotateX(-30deg);
        }

        .delay-1 {
            animation-delay: 0.1s;
        }

        .delay-2 {
            animation-delay: 0.2s;
        }

        .delay-3 {
            animation-delay: 0.3s;
        }

        .delay-4 {
            animation-delay: 0.4s;
        }

        .delay-5 {
            animation-delay: 0.5s;
        }

        @keyframes fadeUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes swingIn {
            to {
                opacity: 1;
                transform: rotateX(0);
            }
        }

        /* Toast */
        #toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
        }

        .toast {
            background: rgba(30, 41, 59, 0.95);
            color: white;
            padding: 12px 24px;
            border-radius: 99px;
            margin-bottom: 10px;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            animation: toastSlide 0.3s ease forwards;
        }

        .toast.success i {
            color: #4ade80;
        }

        .toast.info i {
            color: #60a5fa;
        }

        @keyframes toastSlide {
            0% {
                transform: translateY(-20px);
                opacity: 0;
            }

            100% {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Ripple effect */
        .ripple {
            position: relative;
            overflow: hidden;
        }

        .ripple:after {
            content: "";
            display: block;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 10%, transparent 10.01%);
            background-repeat: no-repeat;
            background-position: 50%;
            transform: scale(10, 10);
            opacity: 0;
            transition: transform .5s, opacity 1s;
        }

        /* Pulse Animation */
        @keyframes pulseSuccess {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.7);
            }

            50% {
                transform: scale(1.02);
                box-shadow: 0 0 0 10px rgba(16, 185, 129, 0);
            }

            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(16, 185, 129, 0);
            }
        }

        .pulse-success {
            animation: pulseSuccess 0.8s ease-out;
        }

        /* Button Busy State */
        .btn-primary.busy,
        .btn-outline.busy {
            opacity: 0.7;
            pointer-events: none;
            cursor: wait;
        }

        /* Developer Console */
        .console-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #1e293b;
            color: #fff;
            border: none;
            border-radius: 50%;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 2000;
            transition: transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .console-toggle:hover {
            transform: scale(1.1) rotate(10deg);
        }

        .dev-console {
            position: fixed;
            top: 0;
            right: -400px;
            width: 400px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 2001;
            transition: right 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            color: #e2e8f0;
            display: flex;
            flex-direction: column;
            box-shadow: -10px 0 30px rgba(0, 0, 0, 0.5);
        }

        .dev-console.open {
            right: 0;
        }

        .console-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
        }

        .console-header h3 {
            font-size: 14px;
            font-family: monospace;
            color: #10B981;
        }

        .console-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-badge {
            font-size: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .sm-btn {
            font-size: 10px;
            padding: 4px 8px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .close-btn {
            background: none;
            border: none;
            color: #64748b;
            cursor: pointer;
            font-size: 18px;
            padding: 4px;
        }

        .close-btn:hover {
            color: white;
            font-size: 18px;
        }

        .console-body {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 12px;
        }

        .log-entry {
            margin-bottom: 8px;
            line-height: 1.4;
            word-break: break-all;
            animation: fadeIn 0.2s;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding-bottom: 4px;
        }

        .log-time {
            color: #64748b;
            margin-right: 8px;
        }

        .log-msg {
            color: #e2e8f0;
        }

        .log-data {
            display: block;
            color: #94a3b8;
            font-size: 11px;
            margin-top: 2px;
            margin-left: 10px;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Mobile Adjustments */
        @media (max-width: 600px) {
            .dev-console {
                width: 100%;
                right: -100%;
            }
        }

        /* Pro Scanner UI */
        .scanner-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #000;
            z-index: 3000;
            display: flex;
            flex-direction: column;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .scanner-modal.active {
            opacity: 1;
            pointer-events: auto;
        }

        .scanner-overlay-ui {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3001;
            display: flex;
            flex-direction: column;
        }

        .scanner-header {
            padding: 20px;
            background: linear-gradient(180deg, rgba(0, 0, 0, 0.8), transparent);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-scanner-icon {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .scan-area-wrapper {
            flex: 1;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* The actual video element container */
        #reader {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
        }

        #reader video {
            object-fit: cover;
            width: 100% !important;
            height: 100% !important;
        }

        /* Guides Overlay */
        .scan-guide {
            width: 280px;
            height: 280px;
            position: relative;
            z-index: 3002;
            box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.6);
            /* Darkens everything outside */
            border-radius: 20px;
        }

        .corner {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid #10B981;
            border-radius: 4px;
        }

        .tl {
            top: -2px;
            left: -2px;
            border-right: 0;
            border-bottom: 0;
        }

        .tr {
            top: -2px;
            right: -2px;
            border-left: 0;
            border-bottom: 0;
        }

        .bl {
            bottom: -2px;
            left: -2px;
            border-right: 0;
            border-top: 0;
        }

        .br {
            bottom: -2px;
            right: -2px;
            border-left: 0;
            border-top: 0;
        }

        .laser-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #ef4444;
            box-shadow: 0 0 10px #ef4444;
            animation: scanLaser 2s infinite linear;
        }

        @keyframes scanLaser {
            0% {
                top: 0;
                opacity: 0;
            }

            20% {
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                top: 100%;
                opacity: 0;
            }
        }

        .scanner-footer {
            padding: 30px;
            background: linear-gradient(0deg, rgba(0, 0, 0, 0.8), transparent);
            color: white;
            text-align: center;
        }

        .scan-status {
            margin-top: 10px;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 2px;
            color: #10B981;
            animation: pulse 1.5s infinite;
        }

        .scan-options {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            margin-top: 10px;
        }

        .btn-text {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 16px;
            border-radius: 99px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .btn-text:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Rewards Modal */
        .rewards-container {
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            background: #fff;
            /* Fallback */
            background: rgba(255, 255, 255, 0.95);
            margin: auto;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .rewards-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .rewards-header h3 {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .rewards-header p {
            font-size: 12px;
            color: var(--text-muted);
        }

        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .reward-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            transition: transform 0.2s;
        }

        .reward-card:active {
            transform: scale(0.95);
        }

        .reward-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            margin-bottom: 12px;
        }

        .shop-icon {
            background: #fee2e2;
            color: #ef4444;
        }

        .food-icon {
            background: #fef3c7;
            color: #d97706;
        }

        .eco-icon {
            background: #dcfce7;
            color: #16a34a;
        }

        .cash-icon {
            background: #dbeafe;
            color: #2563eb;
        }

        .reward-card h4 {
            font-size: 14px;
            margin-bottom: 4px;
        }

        .reward-card .cost {
            font-size: 12px;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 12px;
        }

        /* Camera Select */
        .camera-select-container {
            padding: 0 20px 10px;
            display: flex;
            justify-content: center;
        }

        .camera-select {
            width: 100%;
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 14px;
            outline: none;
            backdrop-filter: blur(4px);
        }

        .camera-select option {
            background: #1e293b;
            color: white;
        }
    </style>

    <!-- Scanner Library -->
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>

<body>

    <div class="background-mesh">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- Header -->
    <header class="glass-header">
        <div class="container header-content">
            <div class="logo">
                <i class="fa-solid fa-recycle logo-icon"></i>
                <div>
                    <h1>EcoReturn</h1>
                    <p>Scan • Return • Earn</p>
                </div>
            </div>
            <div class="user-profile-summary">
                <div class="user-avatar">
                    <i class="fa-solid fa-user"></i>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <!-- Hero Stats / Wallet -->
        <section class="wallet-card glass-panel swing-in">
            <div class="wallet-header">
                <h3>Total Balance</h3>
                <span class="currency">INR</span>
            </div>
            <div class="wallet-balance">
                <span class="symbol">₹</span><span id="balance" class="counter">0</span>
            </div>

            <div class="wallet-footer">
                <div class="eco-points">
                    <div class="icon-circle"><i class="fa-solid fa-leaf"></i></div>
                    <div>
                        <span class="label">Eco Points</span>
                        <div class="value"><span id="points" class="counter">0</span> pts</div>
                    </div>
                </div>
                <div class="progress-container">
                    <div class="progress-label">
                        <span>Level Progress</span>
                        <span class="percentage">0%</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-bar" id="progress"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Action Grid -->
        <section class="action-grid">
            <!-- Scan Card -->
            <div class="card glass-panel fade-up delay-1">
                <div class="card-badge">Step 1</div>
                <div class="card-icon gradient-1">
                    <i class="fa-solid fa-barcode"></i>
                </div>
                <h2>Scan Product</h2>
                <p>Identify refundable plastics instantly.</p>
                <button onclick="scanBottle()" class="btn-primary ripple">
                    <i class="fa-solid fa-expand"></i> Scan Now
                </button>
            </div>

            <!-- Return Card -->
            <div class="card glass-panel fade-up delay-2">
                <div class="card-badge">Step 2</div>
                <div class="card-icon gradient-2">
                    <i class="fa-solid fa-trash-arrow-up"></i>
                </div>
                <h2>Return Plastic</h2>
                <p>Deposit at nearest smart bin.</p>
                <button onclick="returnBottle()" class="btn-primary ripple">
                    <i class="fa-solid fa-arrow-right-to-bracket"></i> Return
                </button>
            </div>

            <!-- Reward Card -->
            <div class="card glass-panel fade-up delay-3">
                <div class="badge-new">New</div>
                <div class="card-icon gradient-3">
                    <i class="fa-solid fa-gift"></i>
                </div>
                <h2>Claim Rewards</h2>
                <p>Convert eco points to value.</p>
                <button onclick="claimReward()" class="btn-outline ripple">
                    <i class="fa-solid fa-star"></i> Redeem
                </button>
            </div>
        </section>

        <!-- Simulation Section -->
        <section class="simulation-area glass-panel fade-up delay-4">
            <div class="section-header">
                <h3><i class="fa-solid fa-robot"></i> System Simulation</h3>
            </div>

            <div class="sim-grid">
                <!-- Mock QR -->
                <div class="sim-item">
                    <h4>Scanner View</h4>
                    <div class="qr-scanner-mock">
                        <div class="scan-line"></div>
                        <i class="fa-solid fa-qrcode"></i>
                        <span class="scan-text">Align Code</span>
                    </div>
                </div>

                <!-- Smart Bin -->
                <div class="sim-item">
                    <h4>Smart Bin</h4>
                    <div class="smart-bin-mock">
                        <div class="lid"></div>
                        <div class="bin-body">
                            <div class="bottle-3d">
                                <div class="bottle-cap"></div>
                                <div class="bottle-neck"></div>
                                <div class="bottle-base"></div>
                            </div>
                        </div>
                        <div class="status-light"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- User Details -->
        <section class="user-details glass-panel fade-up delay-5">
            <h3><i class="fa-solid fa-id-card"></i> Payout Details</h3>
            <div class="input-group">
                <div class="input-wrapper">
                    <i class="fa-solid fa-phone"></i>
                    <input type="tel" placeholder="Phone Number">
                </div>
                <div class="input-wrapper">
                    <i class="fa-solid fa-wallet"></i>
                    <input type="text" placeholder="UPI ID">
                </div>
            </div>
            <button id="save-profile" onclick="showToast('Details saved successfully!', 'success')"
                class="btn-block ripple">Save
                Details</button>
        </section>
    </main>

    <!-- Bottom Nav -->
    <nav class="bottom-nav glass-nav">
        <a href="#" class="nav-item active">
            <i class="fa-solid fa-house"></i>
            <span>Home</span>
        </a>
        <a href="#" class="nav-item">
            <div class="scan-fab">
                <i class="fa-solid fa-expand"></i>
            </div>
        </a>
        <a href="#" class="nav-item">
            <i class="fa-solid fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Scanner Modal -->
    <div id="scanner-modal" class="scanner-modal">
        <div class="scanner-overlay-ui">
            <div class="scanner-header">
                <h3>Scan Barcode</h3>
                <button id="close-scanner-btn" class="close-scanner-icon"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <!-- Camera Select -->
            <div class="camera-select-container">
                <select id="camera-select" class="camera-select">
                    <option value="" disabled selected>Select Camera...</option>
                </select>
            </div>

            <div class="scan-area-wrapper">
                <div id="reader"></div>
                <div class="scan-guide">
                    <div class="laser-line"></div>
                    <div class="corner tl"></div>
                    <div class="corner tr"></div>
                    <div class="corner bl"></div>
                    <div class="corner br"></div>
                </div>
            </div>

            <div class="scanner-footer">
                <p>Point camera at plastic bottle barcode</p>
                <div class="scan-options">
                    <div id="scan-status-text" class="scan-status">Searching...</div>
                    <label for="scan-file-input" class="btn-text ripple">
                        <i class="fa-solid fa-image"></i> Upload Image
                    </label>
                    <input type="file" id="scan-file-input" accept="image/*" style="display: none;">
                </div>
            </div>
        </div>
    </div>

    <!-- Rewards Modal -->
    <div id="rewards-modal" class="scanner-modal">
        <div class="rewards-container glass-panel">
            <div class="rewards-header">
                <div>
                    <h3>Rewards Catalog</h3>
                    <p>Redeem your Eco Points</p>
                </div>
                <button id="close-rewards-btn" class="close-scanner-icon"><i class="fa-solid fa-xmark"></i></button>
            </div>

            <div class="rewards-grid">
                <!-- Reward Item 1 -->
                <div class="reward-card">
                    <div class="reward-icon shop-icon"><i class="fa-brands fa-amazon"></i></div>
                    <h4>₹500 Voucher</h4>
                    <p class="cost">500 Pts</p>
                    <button onclick="App.redeemItem(500, 'Amazon Voucher')" class="btn-redeem ripple">
                        Claim
                    </button>
                </div>
                <!-- Reward Item 2 -->
                <div class="reward-card">
                    <div class="reward-icon food-icon"><i class="fa-solid fa-burger"></i></div>
                    <h4>Free Meal</h4>
                    <p class="cost">300 Pts</p>
                    <button onclick="App.redeemItem(300, 'Free Meal')" class="btn-redeem ripple">
                        Claim
                    </button>
                </div>
                <!-- Reward Item 3 -->
                <div class="reward-card">
                    <div class="reward-icon eco-icon"><i class="fa-solid fa-bag-shopping"></i></div>
                    <h4>Jute Bag</h4>
                    <p class="cost">150 Pts</p>
                    <button onclick="App.redeemItem(150, 'Jute Bag')" class="btn-redeem ripple">
                        Claim
                    </button>
                </div>
                <!-- Reward Item 4 -->
                <div class="reward-card">
                    <div class="reward-icon cash-icon"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                    <h4>Cash ₹10</h4>
                    <p class="cost">50 Pts</p>
                    <button onclick="App.redeemItem(50, 'Cash ₹10')" class="btn-redeem ripple">
                        Claim
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        /**
         * PLASTIC REFUND APP - CORE LOGIC
         * Includes:
         * 1. "Serverless" Backend Simulation (using localStorage)
         * 2. Fetch Interceptor (to route API calls to local backend)
         * 3. Frontend Controller (UI updates, animations)
         */

        /* =========================================
           BACKEND SIMULATION (Server Layer)
           ========================================= */
        const DB_PREFIX = 'eco_return_db_';
        const LOG_LIMIT = 500;

        class MockServer {
            constructor() {
                this.logs = [];
            }

            // --- Database Helpers ---

            _getUser(userId) {
                const key = `${DB_PREFIX}${userId}`;
                const raw = localStorage.getItem(key);
                if (!raw) {
                    // Create new mock user
                    const newUser = {
                        id: userId,
                        balance: 0,
                        ecoPoints: 0,
                        phone: '',
                        upi: '',
                        history: [],
                        createdAt: Date.now()
                    };
                    this._saveUser(newUser);
                    this._log(`[DB] Created new user: ${userId}`);
                    return newUser;
                }
                return JSON.parse(raw);
            }

            _saveUser(user) {
                localStorage.setItem(`${DB_PREFIX}${user.id}`, JSON.stringify(user));
            }

            _getAllUsers() {
                const users = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key.startsWith(DB_PREFIX)) {
                        users.push(JSON.parse(localStorage.getItem(key)));
                    }
                }
                return users;
            }

            _log(message, data = null) {
                const entry = { timestamp: new Date().toISOString(), message, data };
                this.logs.push(entry);
                if (this.logs.length > LOG_LIMIT) this.logs.shift();

                // Dispatch event for UI to update console
                window.dispatchEvent(new CustomEvent('server-log', { detail: entry }));
                console.log(`%cSERVER: ${message}`, 'color: #10B981; font-weight: bold;', data || '');
            }

            // --- API Handlers ---

            async handleRequest(path, method, body) {
                this._log(`Request: ${method} ${path}`, body);

                await new Promise(r => setTimeout(r, 600)); // Simulate network latency

                try {
                    // POST /scan
                    if (path === '/api/scan' && method === 'POST') {
                        const { userId } = body;
                        const isRefundable = Math.random() > 0.1; // 90% chance of success

                        if (isRefundable) {
                            const user = this._getUser(userId);
                            user.history.push({
                                type: 'SCAN',
                                desc: 'Scanned refundable plastic',
                                timestamp: Date.now()
                            });
                            this._saveUser(user);
                            return { status: 200, data: { valid: true, message: 'Refundable item detected' } };
                        } else {
                            return { status: 400, data: { valid: false, message: 'Item code not recognized' } };
                        }
                    }

                    // POST /return
                    if (path === '/api/return' && method === 'POST') {
                        const { userId } = body;
                        const user = this._getUser(userId);

                        const deposit = 5; // Fixed rate per bottle
                        const points = 10;

                        user.balance += deposit;
                        user.ecoPoints += points;
                        user.history.push({
                            type: 'RETURN',
                            desc: `Returned plastic (+₹${deposit})`,
                            timestamp: Date.now(),
                            amount: deposit,
                            points: points
                        });

                        this._saveUser(user);
                        this._log(`Processed return for ${userId}: +₹${deposit}`);

                        return {
                            status: 200, data: {
                                success: true,
                                newBalance: user.balance,
                                newPoints: user.ecoPoints,
                                message: 'Deposit successful'
                            }
                        };
                    }

                    // POST /reward/redeem
                    if (path === '/api/reward/redeem' && method === 'POST') {
                        const { userId, item, cost } = body;
                        const user = this._getUser(userId);

                        // Use provided cost or default to 50
                        const finalCost = cost || 50;

                        if (user.ecoPoints < finalCost) {
                            return { status: 400, data: { success: false, message: `Insufficient points (Need ${finalCost})` } };
                        }

                        // Default cash logic if no item name provided
                        const redeemedPoints = finalCost;
                        let cashValue = 0;

                        if (!item || item.includes('Cash')) {
                            // Simple conversion rate 5pts = 1Rs
                            cashValue = redeemedPoints / 5;
                            user.balance += cashValue;
                        }

                        user.ecoPoints -= redeemedPoints;

                        const desc = item ? `Redeemed: ${item}` : `Redeemed ${redeemedPoints} pts`;

                        user.history.push({
                            type: 'REDEEM',
                            desc: desc,
                            timestamp: Date.now(),
                            amount: cashValue,
                            points: -redeemedPoints
                        });

                        this._saveUser(user);
                        return {
                            status: 200, data: {
                                success: true,
                                newBalance: user.balance,
                                newPoints: user.ecoPoints,
                                message: `Redeemed Successfully!`
                            }
                        };
                    }

                    // GET /user/:id
                    if (path.startsWith('/api/user/') && method === 'GET') {
                        const userId = path.split('/').pop();
                        const user = this._getUser(userId);
                        return { status: 200, data: user };
                    }

                    // POST /user/:id
                    if (path.startsWith('/api/user/') && method === 'POST') {
                        const userId = path.split('/').pop();
                        const user = this._getUser(userId);
                        const { phone, upi } = body;
                        if (phone) user.phone = phone;
                        if (upi) user.upi = upi;
                        this._saveUser(user);
                        return { status: 200, data: { success: true, message: 'Profile updated' } };
                    }

                    // ADMIN: GET /admin/db
                    if (path === '/api/admin/db' && method === 'GET') {
                        return { status: 200, data: { users: this._getAllUsers() } };
                    }

                    return { status: 404, data: { error: 'Not Found' } };

                } catch (err) {
                    this._log('Server Error', err);
                    return { status: 500, data: { error: 'Internal Server Error' } };
                }
            }
        }

        // Initialize Singleton Server
        const mockServer = new MockServer();

        // --- Fetch Interceptor ---
        const originalFetch = window.fetch;
        window.fetch = async (url, options = {}) => {
            // Only intercept local API calls
            if (url.startsWith('/api/')) {
                const method = options.method || 'GET';
                const body = options.body ? JSON.parse(options.body) : {};

                const response = await mockServer.handleRequest(url, method, body);

                return new Response(JSON.stringify(response.data), {
                    status: response.status,
                    headers: { 'Content-Type': 'application/json' }
                });
            }
            return originalFetch(url, options);
        };


        /* =========================================
           FRONTEND CONTROLLER (Client Layer)
           ========================================= */

        const App = {
            state: {
                currentUser: 'demo_user',
                balance: 0,
                ecoPoints: 0,
                isBusy: false
            },

            init() {
                this.renderConsole();
                this.bindEvents();
                this.refreshUserData();
                this.initTilt(); // Initialize 3D effects

                // Listen for server logs
                window.addEventListener('server-log', (e) => {
                    this.addConsoleLog(e.detail);
                });
            },

            bindEvents() {
                // Toggle Console
                document.getElementById('toggle-console').addEventListener('click', () => {
                    document.getElementById('dev-console').classList.toggle('open');
                });

                // Save Profile
                document.getElementById('save-profile')?.addEventListener('click', this.saveProfile.bind(this));

                // Scan File Input
                document.getElementById('scan-file-input')?.addEventListener('change', this.handleFileScan.bind(this));

                // Rewards Modal Close
                document.getElementById('close-rewards-btn')?.addEventListener('click', this.closeRewards.bind(this));

                // Camera Select Change
                document.getElementById('camera-select')?.addEventListener('change', this.switchCamera.bind(this));
            },

            async refreshUserData() {
                try {
                    const res = await fetch(`/api/user/${this.state.currentUser}`);
                    const data = await res.json();

                    // Update State
                    const oldBalance = this.state.balance;
                    const oldPoints = this.state.ecoPoints;

                    this.state.balance = data.balance;
                    this.state.ecoPoints = data.ecoPoints;

                    // Render
                    this.animateValue('balance', oldBalance, this.state.balance, 1000);
                    this.animateValue('points', oldPoints, this.state.ecoPoints, 1000);
                    this.updateProgress();

                    // Pre-fill profile
                    if (data.phone) document.querySelector('input[type="tel"]').value = data.phone;
                    if (data.upi) document.querySelector('input[placeholder="UPI ID"]').value = data.upi;

                } catch (err) {
                    console.error('Failed to sync', err);
                }
            },

            async handleScan(btn) {
                if (this.state.isBusy) return;

                const modal = document.getElementById('scanner-modal');
                modal.classList.add('active');

                // Check library
                if (typeof Html5Qrcode === 'undefined') {
                    this.showToast('Scanner library not loaded', 'error');
                    modal.classList.remove('active');
                    return;
                }

                // --- 1. SETUP SCANNER INSTANCE ---
                // Clean up any existing instance to avoid state issues
                if (this.html5QrCode) {
                    try { await this.html5QrCode.stop(); } catch (e) { }
                    try { await this.html5QrCode.clear(); } catch (e) { }
                }
                this.html5QrCode = new Html5Qrcode("reader");

                // --- 2. START CAMERA ---
                // "qrbox" Error Fix: Use a function to calculate box size dynamically based on the video stream size
                // This prevents "qrbox > minBorderSize" errors on desktop/mobile
                const config = {
                    fps: 10,
                    qrbox: (viewfinderWidth, viewfinderHeight) => {
                        const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                        return {
                            width: Math.floor(minEdge * 0.7),
                            height: Math.floor(minEdge * 0.7)
                        };
                    },
                    aspectRatio: 1.0
                };

                try {
                    // Explicitly ask for cameras first
                    const devices = await Html5Qrcode.getCameras();
                    this.addConsoleLog({ message: `Found ${devices.length} cameras`, data: devices, timestamp: Date.now() });

                    const select = document.getElementById('camera-select');

                    // Populate select if empty
                    if (select.options.length <= 1 && devices && devices.length > 0) {
                        select.innerHTML = '<option value="" disabled selected>Select Camera...</option>';
                        devices.forEach(device => {
                            const option = document.createElement('option');
                            option.value = device.id;
                            option.innerText = device.label || `Camera ${select.options.length}`;
                            select.appendChild(option);
                        });
                    }

                    if (devices && devices.length > 0) {
                        // Default to first camera if nothing selected
                        let cameraId = select.value || devices[0].id;

                        // Prioritize Desktop/User Camera
                        if (!select.value && devices.length > 1) {
                            const userCam = devices.find(d =>
                                d.label.toLowerCase().includes('user') ||
                                d.label.toLowerCase().includes('front') ||
                                d.label.toLowerCase().includes('webcam') ||
                                d.label.toLowerCase().includes('integrated')
                            );
                            if (userCam) cameraId = userCam.id;
                        }

                        // Sync select value
                        select.value = cameraId;

                        this.addConsoleLog({ message: `Starting camera: ${cameraId}`, timestamp: Date.now() });

                        await this.html5QrCode.start(
                            cameraId,
                            config,
                            this.onScanSuccess.bind(this, btn, modal),
                            (errorMessage) => { /* ignore frame errors */ }
                        );
                    } else {
                        this.showToast('No cameras found', 'error');
                        alert("No cameras were found on your device. Please ensure your camera is connected and you have granted permission.");
                        modal.classList.remove('active');
                    }
                } catch (err) {
                    console.error("Camera Error:", err);
                    this.addConsoleLog({ message: "Camera Start Error", data: err.toString(), timestamp: Date.now() });
                    modal.classList.remove('active');

                    // Show explicit error to user
                    alert(`Camera Error: ${err.name || 'Unknown'}\n${err.message || err}\n\nTry reloading or checking browser permissions.`);
                    this.showToast('Camera Failed', 'error');
                }

                // --- 3. BIND CLOSE BUTTON ---
                const closeBtn = document.getElementById('close-scanner-btn');
                const newItem = closeBtn.cloneNode(true);
                closeBtn.parentNode.replaceChild(newItem, closeBtn);

                newItem.addEventListener('click', () => {
                    this.stopScanner(modal);
                });
            },

            async onScanSuccess(btn, modal, decodedText, decodedResult) {
                // Stop scanning immediately
                await this.stopScanner(modal);

                this.showToast('Code Detected!', 'success');

                // Send to backend
                this.setBusy(btn, true, 'Verifying...');
                try {
                    const res = await fetch('/api/scan', {
                        method: 'POST',
                        body: JSON.stringify({ userId: this.state.currentUser, code: decodedText })
                    });
                    const data = await res.json();

                    if (res.status === 200) {
                        this.showToast(data.message, 'success');
                    } else {
                        this.showToast(data.message, 'error');
                    }
                } finally {
                    this.setBusy(btn, false, 'Scan Now');
                }
            },

            async stopScanner(modal) {
                if (this.html5QrCode) {
                    try {
                        // If it's running (state == 2 or 3), stop it
                        if (this.html5QrCode.isScanning) {
                            await this.html5QrCode.stop();
                        }
                        // Clear the canvas/video element
                        await this.html5QrCode.clear();
                    } catch (err) {
                        console.warn("Scanner stop warning:", err);
                    }
                }
                modal.classList.remove('active');
            },

            async handleReturn(btn) {
                if (this.state.isBusy) return;

                // Quick visual check before API
                const originalText = btn.innerHTML;
                this.setBusy(btn, true, 'Processing...');

                try {
                    const res = await fetch('/api/return', {
                        method: 'POST',
                        body: JSON.stringify({ userId: this.state.currentUser })
                    });
                    const data = await res.json();

                    if (res.status === 200) {
                        this.refreshUserData();
                        this.showToast(`+₹${data.newBalance - this.state.balance} Credited!`, 'success');
                        this.confettiEffect();
                    }
                } finally {
                    this.setBusy(btn, false, 'Return');
                }
            },

            async handleRedeem(btn) {
                if (this.state.isBusy) return;
                this.openRewards();
            },

            openRewards() {
                document.getElementById('rewards-modal').classList.add('active');
            },

            closeRewards() {
                document.getElementById('rewards-modal').classList.remove('active');
            },

            async redeemItem(cost, name) {
                if (this.state.isBusy) return;

                // Optimistic check
                if (this.state.ecoPoints < cost) {
                    this.showToast(`Need ${cost} points (You have ${this.state.ecoPoints})`, 'error');
                    return;
                }

                if (!confirm(`Redeem ${name} for ${cost} points?`)) return;

                // Call API
                try {
                    const res = await fetch('/api/reward/redeem', {
                        method: 'POST',
                        // We send a generic redeem request, but in a real app we'd send item ID
                        // For this mock, we'll just trust the backend logic or modify it slightly if needed.
                        // Actually, let's reuse the existing mock endpoint but we might need to adjust it to accept cost overrides or just handle it client side for simulation
                        // Let's modify the body to simulate different items
                        body: JSON.stringify({ userId: this.state.currentUser, item: name, cost: cost })
                    });

                    // Note: The existing mock backend is hardcoded for 50 pts = 10 Rs.
                    // We should update the backend or just override state here for the demo.
                    // Let's rely on the backend response but if it fails purely on points, we handle it.

                    // To support custom costs, we need to update the MockServer logic too, 
                    // OR we can just simulate it here for the user since the backend is in this file too!
                    // Let's cheat a bit and update the Mock Backend logic below via a separate patch OR assume the backend is flexible.
                    // Wait, the backend is IN THIS FILE. I should update handleRequest in MockServer too to support variable costs.
                    // But let's first see if I can just pass it.

                    const data = await res.json();

                    if (res.status === 200) {
                        this.refreshUserData();
                        this.showToast(`Redeemed: ${name}`, 'success');
                        this.closeRewards();
                        this.confettiEffect();
                    } else {
                        this.showToast(data.message, 'error');
                    }
                } catch (e) {
                    console.error(e);
                }
            },

            async handleFileScan(e) {
                if (e.target.files.length === 0) return;

                const file = e.target.files[0];
                const modal = document.getElementById('scanner-modal');

                // Use singleton
                if (!this.html5QrCode) {
                    this.html5QrCode = new Html5Qrcode("reader");
                }

                try {
                    this.setBusy(document.querySelector('.scan-options'), true, 'Scanning File...');
                    document.getElementById('scan-status-text').innerText = "Analyzing Image...";

                    const decodedText = await this.html5QrCode.scanFile(file, true);
                    this.onScanSuccess(null, modal, decodedText, null);
                } catch (err) {
                    console.error(err);
                    this.showToast("No QR/Barcode found in image", 'error');
                    document.getElementById('scan-status-text').innerText = "Try another image";
                } finally {
                    this.setBusy(document.querySelector('.scan-options'), false, 'Search'); // Reset UI
                    e.target.value = ''; // Reset input
                }
            },

            async saveProfile() {
                const phone = document.querySelector('input[type="tel"]').value;
                const upi = document.querySelector('input[placeholder="UPI ID"]').value;

                const res = await fetch(`/api/user/${this.state.currentUser}`, {
                    method: 'POST',
                    body: JSON.stringify({ phone, upi })
                });

                if (res.ok) this.showToast('Details Saved', 'success');
            },

            async switchCamera(e) {
                const cameraId = e.target.value;
                if (!cameraId || !this.html5QrCode) return;

                // Restart with new camera
                try {
                    if (this.html5QrCode.isScanning) {
                        await this.html5QrCode.stop();
                    }

                    // Fixed Config for Switch Camera too
                    const config = {
                        fps: 10,
                        qrbox: (viewfinderWidth, viewfinderHeight) => {
                            const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
                            return {
                                width: Math.floor(minEdge * 0.7),
                                height: Math.floor(minEdge * 0.7)
                            };
                        },
                        aspectRatio: 1.0
                    };

                    // Re-bind success callback correctly (we need reference to btn and modal from context or arguments)
                    // Limitation: We don't have btn passed here easily. 
                    // Workaround: We cache the btn/modal when handleScan is called OR just pass generic args.
                    // For now, let's grab modal by ID. Btn reset is handled by finally in success.
                    // We can't really access 'btn' here easily to stop the spinner if we just crashed, 
                    // but onScanSuccess handles the logic. We'll pass null for btn for now or find the active one.
                    const modal = document.getElementById('scanner-modal');
                    const activeBtn = document.querySelector('.btn-primary.busy'); // Heuristic

                    await this.html5QrCode.start(
                        cameraId,
                        config,
                        this.onScanSuccess.bind(this, activeBtn, modal),
                        () => { }
                    );
                } catch (err) {
                    console.error("Failed to switch camera", err);
                    this.showToast("Failed to switch camera", 'error');
                }
            },

            // --- Visualization Helpers ---

            animateValue(id, start, end, duration) {
                if (start === end) return;
                const obj = document.getElementById(id);
                const range = end - start;
                let startTimestamp = null;
                const step = (timestamp) => {
                    if (!startTimestamp) startTimestamp = timestamp;
                    const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                    obj.innerHTML = Math.floor(progress * range + start);
                    if (progress < 1) {
                        window.requestAnimationFrame(step);
                    } else {
                        obj.innerHTML = end;
                    }
                };
                window.requestAnimationFrame(step);
            },

            updateProgress() {
                const progress = Math.min((this.state.ecoPoints / 100) * 100, 100);
                document.getElementById('progress').style.width = progress + '%';
                document.querySelector('.percentage').innerText = Math.round(progress) + '%';
            },

            setBusy(btn, isBusy, text) {
                this.state.isBusy = isBusy;
                if (isBusy) {
                    btn.dataset.original = btn.innerHTML;
                    btn.innerHTML = `<i class="fa-solid fa-circle-notch fa-spin"></i> ${text}`;
                    btn.classList.add('busy');
                } else {
                    // Restore icon if it was Scan or Return, hardcoded for now or use dataset
                    if (text === 'Scan Now') btn.innerHTML = '<i class="fa-solid fa-expand"></i> Scan Now';
                    else if (text === 'Return') btn.innerHTML = '<i class="fa-solid fa-arrow-right-to-bracket"></i> Return';
                    else if (text === 'Redeem') btn.innerHTML = '<i class="fa-solid fa-star"></i> Redeem';
                    else btn.innerHTML = btn.dataset.original || text;

                    btn.classList.remove('busy');
                }
            },

            showToast(msg, type = 'info') {
                const container = document.getElementById('toast-container');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;

                let icon = '<i class="fa-solid fa-info-circle"></i>';
                if (type === 'success') icon = '<i class="fa-solid fa-check-circle"></i>';
                if (type === 'error') icon = '<i class="fa-solid fa-exclamation-circle"></i>';

                toast.innerHTML = `${icon} <span>${msg}</span>`;
                container.appendChild(toast);

                // Entrance
                requestAnimationFrame(() => toast.classList.add('show'));

                // Removal
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            confettiEffect() {
                const duration = 3000;
                const animationEnd = Date.now() + duration;
                const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

                const randomInRange = (min, max) => Math.random() * (max - min) + min;

                const interval = setInterval(function () {
                    const timeLeft = animationEnd - Date.now();

                    if (timeLeft <= 0) {
                        return clearInterval(interval);
                    }

                    const particleCount = 50 * (timeLeft / duration);

                    // We need a confetti library or simple custom impl. 
                    // Since we don't have libraries, I'll use a simple DOM-based explosion controller
                    App.spawnConfetti();
                }, 250);

                const wallet = document.querySelector('.wallet-card');
                wallet.classList.add('pulse-success');
                setTimeout(() => wallet.classList.remove('pulse-success'), 1000);
            },

            spawnConfetti() {
                // Simple DOM confetti
                const colors = ['#10B981', '#0EA5E9', '#F59E0B', '#EC4899'];
                for (let i = 0; i < 10; i++) {
                    const el = document.createElement('div');
                    el.className = 'confetti';
                    el.style.left = Math.random() * 100 + 'vw';
                    el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                    el.style.animationDuration = (Math.random() * 2 + 1) + 's';
                    document.body.appendChild(el);
                    setTimeout(() => el.remove(), 3000);
                }
            },

            // --- 3D TILT EFFECT ---
            initTilt() {
                document.querySelectorAll('.card, .wallet-card').forEach(card => {
                    card.addEventListener('mousemove', (e) => {
                        const rect = card.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;

                        // Calculate rotation based on cursor position
                        const centerX = rect.width / 2;
                        const centerY = rect.height / 2;

                        const rotateX = ((y - centerY) / centerY) * -5; // Max 5 deg
                        const rotateY = ((x - centerX) / centerX) * 5;

                        card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;

                        // Glare effect
                        const glareX = (x / rect.width) * 100;
                        const glareY = (y / rect.height) * 100;
                        card.style.setProperty('--glare-pos', `${glareX}% ${glareY}%`);
                    });

                    card.addEventListener('mouseleave', () => {
                        card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0) scale(1)';
                        card.style.setProperty('--glare-pos', `50% 50%`);
                    });
                });
            },

            // --- Console UI ---
            renderConsole() {
                const consoleHTML = `
            <div id="dev-console" class="dev-console">
                <div class="console-header">
                    <h3><i class="fa-solid fa-terminal"></i> Backend Console</h3>
                    <div class="console-actions">
                        <span class="user-badge">User: ${this.state.currentUser}</span>
                        <button onclick="App.clearDb()" class="sm-btn">Clear DB</button>
                        <button onclick="App.toggleConsole()" class="close-btn"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                </div>
                <div class="console-body" id="console-logs">
                    <div class="log-entry system">> Backend initialized...</div>
                    <div class="log-entry system">> Listening on /api/...</div>
                </div>
            </div>
            <button id="toggle-console" class="console-toggle" title="Open Developer Console">
                <i class="fa-solid fa-code"></i>
            </button>
        `;
                document.body.insertAdjacentHTML('beforeend', consoleHTML);
            },

            addConsoleLog(entry) {
                const logs = document.getElementById('console-logs');
                if (!logs) return;

                const div = document.createElement('div');
                div.className = 'log-entry';

                const time = new Date(entry.timestamp).toLocaleTimeString();
                const dataStr = entry.data ? `<span class="log-data">${JSON.stringify(entry.data)}</span>` : '';

                div.innerHTML = `<span class="log-time">[${time}]</span> <span class="log-msg">${entry.message}</span> ${dataStr}`;
                logs.appendChild(div);
                logs.scrollTop = logs.scrollHeight;
            },

            toggleConsole() {
                document.getElementById('dev-console').classList.remove('open');
            },

            clearDb() {
                if (confirm('Reset all data?')) {
                    localStorage.clear();
                    location.reload();
                }
            }
        };

        // Expose to window for inline onclicks
        window.App = App;
        window.scanBottle = (btn) => App.handleScan(event.currentTarget);
        window.returnBottle = (btn) => App.handleReturn(event.currentTarget);
        window.claimReward = (btn) => App.handleRedeem(event.currentTarget);

        // Start
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>